{% extends "base.html" %}

{% block title %}{{ t('dashboard') }} - {{ t('app_name') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-chart-pie me-2"></i>{{ t('financial_overview') }}</h4>
                <div class="d-flex gap-2 align-items-center">
                    <div class="d-flex gap-1">
                        <button id="dashboardTtsToggle" class="btn btn-outline-success btn-sm" title="Toggle Text-to-Speech">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <select id="dashboardVoiceSelect" class="form-select form-select-sm" style="width: auto;" title="Select Voice">
                            <option value="">Default Voice</option>
                        </select>
                    </div>
                    <a href="{{ url_for('ai_assistant') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-robot me-1"></i>AI Assistant
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if accessible_data.assets and financial_data.assets %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-success mb-0">
                                        <i class="fas fa-wallet me-1"></i>{{ t('total_assets') }}
                                    </h6>
                                    <button class="btn btn-sm btn-outline-primary read-aloud-btn" 
                                            data-text="Your total assets are ${{ '{:,}'.format(financial_data.assets.total_assets) }}. Cash: ${{ '{:,}'.format(financial_data.assets.cash) }}, Bank balance: ${{ '{:,}'.format(financial_data.assets.bank_balance) }}, Property value: ${{ '{:,}'.format(financial_data.assets.property_value) }}" 
                                            title="Read aloud">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <h3 class="text-success">${{ "{:,}".format(financial_data.assets.total_assets) }}</h3>
                                <small class="text-muted">
                                    Cash: ${{ "{:,}".format(financial_data.assets.cash) }}<br>
                                    Bank: ${{ "{:,}".format(financial_data.assets.bank_balance) }}<br>
                                    Property: ${{ "{:,}".format(financial_data.assets.property_value) }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if accessible_data.liabilities and financial_data.liabilities %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-danger mb-0">
                                        <i class="fas fa-credit-card me-1"></i>{{ t('total_liabilities') }}
                                    </h6>
                                    <button class="btn btn-sm btn-outline-primary read-aloud-btn" 
                                            data-text="Your total liabilities are ${{ '{:,}'.format(financial_data.liabilities.total_liabilities) }}. Credit card debt: ${{ '{:,}'.format(financial_data.liabilities.credit_card_debt) }}, Personal loan: ${{ '{:,}'.format(financial_data.liabilities.personal_loan) }}, Mortgage: ${{ '{:,}'.format(financial_data.liabilities.mortgage) }}" 
                                            title="Read aloud">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <h3 class="text-danger">${{ "{:,}".format(financial_data.liabilities.total_liabilities) }}</h3>
                                <small class="text-muted">
                                    Credit Card: ${{ "{:,}".format(financial_data.liabilities.credit_card_debt) }}<br>
                                    Personal Loan: ${{ "{:,}".format(financial_data.liabilities.personal_loan) }}<br>
                                    Mortgage: ${{ "{:,}".format(financial_data.liabilities.mortgage) }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if accessible_data.credit_score and financial_data.credit_score %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-info mb-0">
                                        <i class="fas fa-star me-1"></i>{{ t('credit_score') }}
                                    </h6>
                                    <button class="btn btn-sm btn-outline-primary read-aloud-btn" 
                                            data-text="Your credit score is {{ financial_data.credit_score.score }} with a {{ financial_data.credit_score.rating }} rating" 
                                            title="Read aloud">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <h3 class="text-info">{{ financial_data.credit_score.score }}</h3>
                                <p class="mb-0 text-muted">{{ financial_data.credit_score.rating }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if accessible_data.investments and financial_data.investments %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-primary mb-0">
                                        <i class="fas fa-chart-line me-1"></i>{{ t('investments') }}
                                    </h6>
                                    <button class="btn btn-sm btn-outline-primary read-aloud-btn" 
                                            data-text="Your total investment value is ${{ '{:,}'.format(financial_data.investments.total_investment_value) }}. Stocks: ${{ '{:,}'.format(financial_data.investments.stocks[0].total_value if financial_data.investments.stocks else 0) }}, Mutual funds: ${{ '{:,}'.format(financial_data.investments.mutual_funds[0].total_value if financial_data.investments.mutual_funds else 0) }}" 
                                            title="Read aloud">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <h3 class="text-primary">${{ "{:,}".format(financial_data.investments.total_investment_value) }}</h3>
                                <small class="text-muted">
                                    {{ t('stocks') }}: ${{ "{:,}".format(financial_data.investments.stocks[0].total_value if financial_data.investments.stocks else 0) }}<br>
                                    {{ t('mutual_funds') }}: ${{ "{:,}".format(financial_data.investments.mutual_funds[0].total_value if financial_data.investments.mutual_funds else 0) }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Net Worth Calculation -->
                {% if accessible_data.assets and accessible_data.liabilities and financial_data.assets and financial_data.liabilities %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-calculator me-2"></i>{{ t('net_worth_label') }}
                                    </h5>
                                    {% set net_worth = financial_data.assets.total_assets - financial_data.liabilities.total_liabilities %}
                                    <button class="btn btn-sm btn-outline-primary read-aloud-btn" 
                                            data-text="Your net worth is ${{ '{:,}'.format(net_worth) }}. This is calculated as total assets of ${{ '{:,}'.format(financial_data.assets.total_assets) }} minus total liabilities of ${{ '{:,}'.format(financial_data.liabilities.total_liabilities) }}" 
                                            title="Read aloud">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <h2 class="{% if net_worth >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ "{:,}".format(net_worth) }}
                                </h2>
                                <p class="text-muted mb-0">
                                    {{ t('net_worth_formula') }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-shield-alt me-2"></i>{{ t('data_access') }}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">{{ t('you_control_data') }}</p>
                <ul class="list-unstyled">
                    {% for category, has_access in accessible_data.items() %}
                    <li class="mb-2">
                        <i class="fas fa-{{ 'check-circle text-success' if has_access else 'times-circle text-danger' }} me-2"></i>
                        {{ category.replace('_', ' ').title() }}
                    </li>
                    {% endfor %}
                </ul>
                <a href="{{ url_for('privacy_settings') }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-cog me-1"></i>{{ t('manage_privacy') }}
                </a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>{{ t('smart_analysis') }}</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('ai_assistant') }}" class="btn btn-primary">
                        <i class="fas fa-robot me-2"></i>{{ t('chat_with_ai') }}
                    </a>
                    <a href="{{ url_for('privacy_settings') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-shield-alt me-2"></i>{{ t('manage_privacy') }}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ttsToggleBtn = document.getElementById('dashboardTtsToggle');
    const voiceSelect = document.getElementById('dashboardVoiceSelect');
    const readAloudBtns = document.querySelectorAll('.read-aloud-btn');

    // TTS State Management
    let ttsEnabled = false;
    let currentSpeech = null;
    let voices = [];
    let selectedVoice = null;

    // Initialize TTS
    function initTTS() {
        if ('speechSynthesis' in window) {
            // Load voices
            function loadVoices() {
                voices = speechSynthesis.getVoices();
                voiceSelect.innerHTML = '<option value="">Default Voice</option>';
                
                voices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
                
                // Auto-select appropriate voice based on current language
                const currentLang = document.documentElement.lang || 'en';
                const preferredVoice = voices.find(voice => 
                    voice.lang.startsWith(currentLang) && voice.default
                );
                if (preferredVoice) {
                    const voiceIndex = voices.indexOf(preferredVoice);
                    voiceSelect.value = voiceIndex;
                    selectedVoice = voices[voiceIndex];
                }
            }

            loadVoices();
            speechSynthesis.addEventListener('voiceschanged', loadVoices);

            // Voice selection handler
            voiceSelect.addEventListener('change', function() {
                const voiceIndex = parseInt(this.value);
                selectedVoice = voiceIndex >= 0 ? voices[voiceIndex] : null;
            });

            // TTS toggle handler
            ttsToggleBtn.addEventListener('click', function() {
                ttsEnabled = !ttsEnabled;
                updateTTSToggleButton();
                
                if (!ttsEnabled && currentSpeech) {
                    speechSynthesis.cancel();
                    currentSpeech = null;
                }
            });

            // Add click handlers to all read aloud buttons
            readAloudBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const textToSpeak = this.getAttribute('data-text');
                    
                    if (currentSpeech && this.classList.contains('playing')) {
                        stopSpeech();
                        this.classList.remove('playing');
                    } else {
                        // Stop any current speech
                        stopSpeech();
                        
                        // Start new speech
                        this.classList.add('playing');
                        speakText(textToSpeak);
                    }
                });
            });

        } else {
            ttsToggleBtn.disabled = true;
            ttsToggleBtn.title = 'Text-to-Speech not supported';
            voiceSelect.disabled = true;
            readAloudBtns.forEach(btn => btn.disabled = true);
        }
    }

    function updateTTSToggleButton() {
        if (ttsEnabled) {
            ttsToggleBtn.className = 'btn btn-success btn-sm';
            ttsToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            ttsToggleBtn.title = 'Text-to-Speech Enabled';
        } else {
            ttsToggleBtn.className = 'btn btn-outline-success btn-sm';
            ttsToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            ttsToggleBtn.title = 'Text-to-Speech Disabled';
        }
    }

    function speakText(text, lang = null) {
        if (!ttsEnabled || !('speechSynthesis' in window)) return;

        // Stop current speech
        if (currentSpeech) {
            speechSynthesis.cancel();
        }

        const utterance = new SpeechSynthesisUtterance(text);
        
        // Set voice
        if (selectedVoice) {
            utterance.voice = selectedVoice;
        } else if (lang && voices.length > 0) {
            // Auto-select voice based on language
            const langVoice = voices.find(voice => voice.lang.startsWith(lang));
            if (langVoice) utterance.voice = langVoice;
        }

        // Set speech parameters
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 0.8;

        utterance.onstart = function() {
            currentSpeech = utterance;
            updatePlayPauseButtons();
        };

        utterance.onend = function() {
            currentSpeech = null;
            updatePlayPauseButtons();
        };

        utterance.onerror = function() {
            currentSpeech = null;
            updatePlayPauseButtons();
        };

        speechSynthesis.speak(utterance);
    }

    function stopSpeech() {
        if (currentSpeech) {
            speechSynthesis.cancel();
            currentSpeech = null;
            updatePlayPauseButtons();
        }
    }

    function updatePlayPauseButtons() {
        const buttons = document.querySelectorAll('.read-aloud-btn');
        buttons.forEach(btn => {
            if (currentSpeech && btn.classList.contains('playing')) {
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                btn.title = 'Pause';
            } else {
                btn.innerHTML = '<i class="fas fa-play"></i>';
                btn.title = 'Read aloud';
            }
        });
    }

    // Initialize TTS
    initTTS();
});
</script>
{% endblock %}
